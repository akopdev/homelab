#!/usr/bin/env bash
set -euo pipefail

NETWORK_NAME="homelab-net"

# --------------------------
# Helpers
# --------------------------
usage() {
    cat <<EOF
Commands:
  run <service_name>   Run the service runner script
  stop <service_name>  Stop the service runner script
EOF
    exit 1
}


get_runner_file() {
    local file="$(dirname "$0")/runners/${1}.sh"

    if [[ ! -f "${file}" ]]; then
        echo "[ERROR] Runner script '${file}' not found." >&2
        exit 1
    fi

    echo "${file}"
}

remove_container() {
    if podman container exists "${1}"; then
        echo "[INFO] Removing existing container '${1}'..."
        podman rm -f "${1}" || true
    fi
}

run_container() {
    # Usage: run_container IMAGE [extra podman args...]

    if [[ -z "${service_name-}" ]]; then
        echo "[ERROR] service_name variable must be set before calling run_container." >&2
        exit 1
    fi

    local image="$1"
    shift || true

    if [[ -z "$image" ]]; then
        echo "[ERROR] Image is required as the first parameter." >&2
        exit 1
    fi

    remove_container "${service_name}"

    echo "[INFO] Starting container '$service_name'..."

    local podman_args=(
        --name "$service_name"
        --restart=always
        --network "${NETWORK_NAME}"
    )

    local env_file="/etc/homelab/environments/${service_name}.env"
    if [[ -f "$env_file" ]]; then
        podman_args+=(--env-file "$env_file")
    fi

    if (( $# > 0 )); then
        podman_args+=("$@")
    fi

    podman run "${podman_args[@]}" "$image"
}

# --------------------------
# Commands
# --------------------------
cmd_run() {
    local service_name="$1"
    local runner_file
    runner_file=$(get_runner_file "$service_name")

    echo "[INFO] Running service '$service_name'..."
    # shellcheck source=/dev/null
    source "$runner_file"
}

cmd_stop() {
    local service_name="$1"
    local runner_file
    runner_file=$(get_runner_file "$service_name")

    echo "[INFO] Stopping service '$service_name'..."
    remove_container "${service_name}"
}

# --------------------------
# Main
# --------------------------
main() {
    if [[ $# -lt 2 ]]; then
        usage
    fi

    local command="$1"
    local service_name="$2"

    case "$command" in
        run)  cmd_run "$service_name" ;;
        stop) cmd_stop "$service_name" ;;
        *)    usage ;;
    esac
}

main "$@"
